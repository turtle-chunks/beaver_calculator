<!DOCTYPE html>
<html>
<head>
  <title>Kill & Drop Rate Calculator</title>
  <script src="jspsych/jspsych.js"></script>
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/plugin-survey-html-form.js"></script>
  <script src="jspsych/plugin-call-function.js"></script>
  <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      background: url('old-school-runescape-map.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    #jspsych-target {
      position: relative;
      height: 100%;
    }
    .instruction-dialog {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: 40px auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .side-image {
      width: 200px;
      height: auto;
    }
    .left-image {
      transform: scaleX(-1);
      margin-right: 20px;
    }
    .right-image {
      margin-left: 20px;
    }
    .instruction-content {
      font-size: 1.1em;
      text-align: center;
      color: #000;
    }
    .instruction-dialog p {
      margin: 0.8em 0;
    }
    .instruction-dialog input,
    .instruction-dialog select {
      padding: 5px;
      font-size: 1em;
      margin-top: 5px;
      width: 100%;
      max-width: 200px;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    .results-table th,
    .results-table td {
      border: 1px solid #bbb;
      padding: 6px;
      font-size: 0.95em;
    }
    .results-table th {
      background: #eee;
    }
  </style>
  <script>
    const createInstructionDialog = content => `
      <div style="display: flex; align-items: center; justify-content: center;">
        <img class="side-image left-image" src="darkwizard.png" alt="Dark Wizard">
        <div class="instruction-dialog">
          <div class="instruction-content">
            ${content}
          </div>
        </div>
        <img class="side-image right-image" src="darkwizard.png" alt="Dark Wizard">
      </div>
    `;

    const jsPsych = initJsPsych();

    const averageDropRates = {
      "Bones": 1,
      "Staff": 0.0625,
      "Wizard hat (black)": 0.007575758,
      "Wizard robe (black)": 0.023435669,
      "Air rune": 0.515606691,
      "Water rune": 0.515606691,
      "Earth rune": 1.640606691,
      "Fire rune": 0.515606691,
      "Body rune": 0.515606691,
      "Mind rune": 0.515606691,
      "Chaos rune": 0.234411627,
      "Blood rune": 0.03125,
      "Cosmic rune": 0.015625,
      "Law rune": 0.0234375,
      "Coins": 1.51552791,
      "Water Talisman": 0.0078125,
      "Fire Talisman": 0.0078125,
      "Beginner clue": 0.02
    };

    let calculationResults;

    // 1) Input form
    const combined_input_trial = {
      type: jsPsychSurveyHtmlForm,
      html: createInstructionDialog(`
        <p><strong>Welcome to the Kill & Drop Rate Calculator.</strong></p>
        <p>Please enter your overall kills and how many of each item you obtained.</p>
        <p>
          <strong>Overall Kills:</strong><br>
          <input name="kills" type="number" step="1" placeholder="e.g. 1000">
        </p>
        ${Object.keys(averageDropRates).map(item => `
          <p>
            ${item}:<br>
            <input name="${item}" type="number" step="1" placeholder="0">
          </p>
        `).join('')}
      `),
      button_label: 'Submit'
    };

    // 2) Calculate metrics
    const calculate_trial = {
      type: jsPsychCallFunction,
      func: () => {
        const raw = jsPsych.data.get().last(1).values()[0].response;
        const resp = typeof raw === 'string' ? JSON.parse(raw) : raw;
        const kills = parseFloat(resp.kills);
        if (isNaN(kills) || kills <= 0) {
          calculationResults = { error: 'Please enter a valid positive number of kills.' };
          return;
        }
        const results = {};
        for (const item of Object.keys(averageDropRates)) {
          const count = parseFloat(resp[item]) || 0;
          const dropRate = count / kills;
          const perDrop = count > 0 ? kills / count : Infinity;
          const relative = dropRate / averageDropRates[item];
          results[item] = { count, dropRate, perDrop, relative };
        }
        calculationResults = results;
      }
    };

    // 3) Feedback screen — no keypress needed
    const feedback_trial = {
      type: jsPsychHtmlKeyboardResponse,
      choices: [],         // <- no keys accepted
      stimulus: () => {
        if (calculationResults.error) {
          return createInstructionDialog(`
            <p>${calculationResults.error}</p>
            <p><strong>To restart, please press F5 on your keyboard.</strong></p>
          `);
        }
        let table = `<table class="results-table">
          <tr>
            <th>Item</th>
            <th>Your Drop Rate</th>
            <th>Kills per Drop</th>
            <th>Relative Rate</th>
            <th>Comparison</th>
          </tr>`;
        for (const [item, stats] of Object.entries(calculationResults)) {
          const dr = stats.dropRate.toFixed(4);
          const kd = stats.perDrop === Infinity ? '∞' : stats.perDrop.toFixed(2);
          const rr = stats.relative.toFixed(4);
          let cmp = '–';
          if (stats.relative > 1) cmp = `${((stats.relative - 1) * 100).toFixed(1)}% ↑`;
          else if (stats.relative < 1) cmp = `${((1 - stats.relative) * 100).toFixed(1)}% ↓`;
          table += `
            <tr>
              <td>${item}</td>
              <td>${dr}</td>
              <td>${kd}</td>
              <td>${rr}</td>
              <td>${cmp}</td>
            </tr>`;
        }
        table += `</table>`;
        return createInstructionDialog(`
          <p><strong>Here are your results:</strong></p>
          ${table}
          <p><strong>To do another calculation, press F5 on your keyboard to refresh this page.</strong></p>
        `);
      }
    };

    jsPsych.run(
      [ combined_input_trial, calculate_trial, feedback_trial ],
      { display_element: document.getElementById('jspsych-target') }
    );
  </script>
</head>
<body>
  <div id="jspsych-target"></div>
</body>
</html>
